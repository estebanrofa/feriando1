<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ feria.nombre }} - Feriando.uy</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="map-container">
                <a href="/" class="boton-volver" onclick="sessionStorage.setItem('navegacionInterna', 'true')">
                    ‚Üê Volver al Lobby
                </a>
                
                <div class="header-feria">
                    <h1>{{ feria.nombre }}</h1>
                    <p>{{ feria.barrio }} - {{ feria.dia }}</p>
                </div>
                
                <div class="leyenda-flotante" id="leyendaBox">
                    <div class="leyenda-header" onclick="toggleLeyenda()">
                        <h3>Categor√≠as</h3>
                        <span class="flecha-toggle" id="flechaLeyenda">‚ñ≤</span>
                    </div>
                    <div class="leyenda-contenido" id="leyendaContenido">
                        <div class="leyenda-item-flotante categoria-filtro active" data-categoria="Todas" onclick="filtrarCategoria('Todas')">
                            <span class="color-box-flotante" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                            <span>Todas</span>
                        </div>
                        {% for categoria, color in categorias_colores.items() %}
                        <div class="leyenda-item-flotante categoria-filtro" data-categoria="{{ categoria }}" onclick="filtrarCategoria('{{ categoria }}')">
                            <span class="color-box-flotante" style="background-color: {{ color }};"></span>
                            <span>{{ categoria }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="barra-info-toggle" onclick="toggleInfoPanel()" id="barraInfoToggle">
                    <div class="flecha-barra">‚óÄ</div>
                    <div class="texto-vertical">Informaci√≥n de Cuadras</div>
                </div>
                
                <button class="boton-nocturno" onclick="toggleModoNocturno()" id="botonModo">
                    üåô Modo Nocturno
                </button>

                <a href="/mapa?feria={{ feria.nombre | urlencode }}" class="boton-ubicacion boton-como-ir">
                    üß≠ C√≥mo ir
                </a>

                <div class="botones-info-ferias">
                    <button class="boton-info-feria" onclick="mostrarMensajeNoDisponible('ofertas')" id="botonOfertas">
                        üè∑Ô∏è Ofertas
                    </button>
                    <button class="boton-info-feria" onclick="mostrarMensajeNoDisponible('recomendaciones')" id="botonRecomendaciones">
                        ‚≠ê Recomendaciones
                    </button>
                </div>

                <div id="map"></div>
            </div>
            
            <div class="info-panel" id="infoPanel">
                <div class="info-header">
                    <h2>Informaci√≥n de Cuadras</h2>
                </div>
                <div class="info-contenido abierto" id="infoContenido">
                    <div id="feria-info">
                        <h3>{{ feria.nombre }}</h3>
                        <p>Haz click en cualquier cuadra del mapa para ver sus productos.</p>
                        
                        <div class="estadisticas-feria">
                            <div class="stat-item">
                                <span class="stat-numero">{{ feria.cuadras|length }}</span>
                                <span class="stat-label">Cuadras</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-numero">{{ categorias_colores|length }}</span>
                                <span class="stat-label">Categor√≠as</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map;
        var capaDia;
        var capaNoche;
        var modoNocturno = false;
        var todasLasLineas = [];
        var categoriaActual = 'Todas';
        var feria = {{ feria | tojson }};
        var categoriasColores = {{ categorias_colores | tojson }};
        var limitesFeria = {{ limites_feria | tojson }};
        
        function toggleModoNocturno() {
            var boton = document.getElementById('botonModo');
            
            if (!modoNocturno) {
                map.removeLayer(capaDia);
                capaNoche.addTo(map);
                boton.innerHTML = '‚òÄÔ∏è Modo D√≠a';
                boton.classList.add('activo');
                modoNocturno = true;
            } else {
                map.removeLayer(capaNoche);
                capaDia.addTo(map);
                boton.innerHTML = 'üåô Modo Nocturno';
                boton.classList.remove('activo');
                modoNocturno = false;
            }
        }
        
        function toggleLeyenda() {
            var contenido = document.getElementById('leyendaContenido');
            var flecha = document.getElementById('flechaLeyenda');
            var leyendaBox = document.getElementById('leyendaBox');
            
            if (contenido.classList.contains('abierto')) {
                contenido.classList.remove('abierto');
                flecha.innerHTML = '‚ñ≤';
                leyendaBox.classList.remove('expandido');
            } else {
                contenido.classList.add('abierto');
                flecha.innerHTML = '‚ñº';
                leyendaBox.classList.add('expandido');
            }
        }
        
        function toggleInfoPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            if (infoPanel.classList.contains('visible')) {
                infoPanel.classList.remove('visible');
                mainContent.classList.remove('panel-visible');
                flecha.innerHTML = '‚óÄ';
                
                setTimeout(function() {
                    if (!infoPanel.classList.contains('visible')) {
                        infoPanel.style.display = 'none';
                    }
                }, 500);
            } else {
                infoPanel.style.display = 'block';
                mainContent.classList.add('panel-visible');
                requestAnimationFrame(function() {
                    infoPanel.classList.add('visible');
                    flecha.innerHTML = '‚ñ∂';
                });
            }
        }
        
        function filtrarCategoria(categoria) {
            categoriaActual = categoria;
            
            document.querySelectorAll('.categoria-filtro').forEach(function(item) {
                if (item.dataset.categoria === categoria) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            todasLasLineas.forEach(function(linea) {
                if (categoria === 'Todas' || linea.categoria === categoria) {
                    linea.setStyle({ opacity: 0.9 });
                    map.addLayer(linea);
                } else {
                    map.removeLayer(linea);
                }
            });
            
            if (categoria !== 'Todas') {
                mostrarInfoCategoria(categoria);
            } else {
                ocultarPanel();
            }
        }
        
        function mostrarInfoCategoria(categoria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            var html = '<h3>Categor√≠a: ' + categoria + '</h3>';
            var color = categoriasColores[categoria];
            html += '<p style="color: ' + color + '">Filtrando por: <strong>' + categoria + '</strong></p>';
            html += '<p>Las cuadras destacadas en el mapa pertenecen a esta categor√≠a.</p>';
            
            var contador = 0;
            feria.cuadras.forEach(function(cuadra) {
                if (cuadra.categoria_principal === categoria) {
                    contador++;
                }
            });
            
            html += '<div class="categoria-stats">';
            html += '<p>üìç <strong>' + contador + '</strong> cuadra(s) encontrada(s)</p>';
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        function ocultarPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            infoPanel.classList.remove('visible');
            mainContent.classList.remove('panel-visible');
            
            setTimeout(function() {
                if (!infoPanel.classList.contains('visible')) {
                    infoPanel.style.display = 'none';
                }
            }, 500);
        }
        
        function mostrarInfoCuadra(cuadra) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var color = categoriasColores[cuadra.categoria_principal];
            
            var html = '<h3>' + feria.nombre + '</h3>';
            html += '<h4 style="color:' + color + '">üìç ' + cuadra.nombre + '</h4>';
            html += '<p class="categoria-principal">Categor√≠a principal: <strong style="color:' + color + '">' + cuadra.categoria_principal + '</strong></p>';
            
            html += '<div class="productos-section">';
            html += '<h5>üì¶ Productos disponibles:</h5>';
            for (var categoria in cuadra.productos) {
                var colorCategoria = categoriasColores[categoria];
                html += '<div class="categoria-section">';
                html += '<h5 style="color:' + colorCategoria + '">' + categoria + '</h5>';
                html += '<ul>';
                cuadra.productos[categoria].forEach(function(producto) {
                    html += '<li>' + producto + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        var polygon = L.polygon(limitesFeria);
        var bounds = polygon.getBounds();
        var zoomInicial = 16.2;

        // Expandir los l√≠mites un poco para dar margen al mover
        var maxBounds = bounds.pad(0.5);

        map = L.map('map', {
            center: bounds.getCenter(),
            zoom: zoomInicial,
            minZoom: zoomInicial,
            maxZoom: 18,
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            touchZoom: true,
            dragging: false,
            maxBounds: maxBounds,
            maxBoundsViscosity: 1.0
        });

        // Habilitar/deshabilitar dragging seg√∫n el nivel de zoom
        map.on('zoomend', function() {
            if (map.getZoom() > zoomInicial) {
                map.dragging.enable();
            } else {
                map.dragging.disable();
                // Volver al centro cuando est√° en zoom inicial
                map.setView(bounds.getCenter(), zoomInicial);
            }
        });

        capaDia = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });

        capaNoche = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });
        
        capaDia.addTo(map);
        
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        map.on('click', function(e) {
            var clickEnLinea = false;
            todasLasLineas.forEach(function(linea) {
                if (linea.getBounds && linea.getBounds().contains(e.latlng)) {
                    clickEnLinea = true;
                }
            });
            
            if (!clickEnLinea) {
                ocultarPanel();
            }
        });

        feria.cuadras.forEach(function(cuadra) {
            var color = categoriasColores[cuadra.categoria_principal];
            
            var polyline = L.polyline(cuadra.coordenadas, {
                color: color,
                weight: 6,
                opacity: 0.9
            }).addTo(map);

            polyline.categoria = cuadra.categoria_principal;
            todasLasLineas.push(polyline);

            polyline.on('click', function() {
                mostrarInfoCuadra(cuadra);
            });

            polyline.bindPopup(
                '<b>' + cuadra.nombre + '</b><br>' +
                'Categor√≠a principal: <span style="color:' + color + '"><b>' + cuadra.categoria_principal + '</b></span>'
            );
        });

        // Funci√≥n para mostrar mensaje de no disponible
        function mostrarMensajeNoDisponible(tipo) {
            var mensaje = tipo === 'ofertas'
                ? 'No hay ofertas disponibles en esta feria por el momento.'
                : 'No hay recomendaciones disponibles en esta feria por el momento.';

            var popup = L.popup()
                .setLatLng(bounds.getCenter())
                .setContent('<div style="text-align: center; padding: 10px;"><b>' + (tipo === 'ofertas' ? 'üè∑Ô∏è' : '‚≠ê') + ' ' + mensaje + '</b></div>')
                .openOn(map);
        }

    </script>
</body>
</html>