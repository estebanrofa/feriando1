<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Ferias - Montevideo</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="map-container">
                <a href="/" class="boton-volver" onclick="sessionStorage.setItem('navegacionInterna', 'true')">
                    ‚Üê Volver
                </a>
                
                <div class="leyenda-flotante" id="leyendaBox" style="display: none;">
                    <div class="leyenda-header" onclick="toggleLeyenda()">
                        <h3>Categor√≠as</h3>
                        <span class="flecha-toggle" id="flechaLeyenda">‚ñ≤</span>
                    </div>
                    <div class="leyenda-contenido" id="leyendaContenido">
                        <div class="leyenda-item-flotante categoria-filtro active" data-categoria="Todas" onclick="filtrarCategoria('Todas')">
                            <span class="color-box-flotante" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                            <span>Todas</span>
                        </div>
                        {% for categoria, color in categorias_colores.items() %}
                        <div class="leyenda-item-flotante categoria-filtro" data-categoria="{{ categoria }}" onclick="filtrarCategoria('{{ categoria }}')">
                            <span class="color-box-flotante" style="background-color: {{ color }};"></span>
                            <span>{{ categoria }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="barra-info-toggle" onclick="toggleInfoPanel()" id="barraInfoToggle">
                    <div class="flecha-barra">‚óÄ</div>
                    <div class="texto-vertical">Informaci√≥n de Cuadras</div>
                </div>
                
                <button class="boton-nocturno" onclick="toggleModoNocturno()" id="botonModo">
                    üåô Modo Nocturno
                </button>

                <button class="boton-ubicacion" id="botonUbicacion">
                    üìç Mi Ubicaci√≥n
                </button>

                <div class="botones-info-ferias">
                    <button class="boton-info-feria" onclick="toggleOfertas()" id="botonOfertas">
                        üè∑Ô∏è Ofertas hoy
                    </button>
                    <button class="boton-info-feria" onclick="toggleRecomendaciones()" id="botonRecomendaciones">
                        ‚≠ê Recomendaciones hoy
                    </button>
                </div>

                <!-- Filtro por d√≠as -->
                <div class="filtro-dias-container" id="filtroDiasContainer">
                    <button class="boton-filtro-dias" onclick="toggleFiltroDias()" id="botonFiltroDias">
                        üìÖ Filtrar
                    </button>
                    <div class="filtro-dias-panel" id="filtroDiasPanel">
                        <div class="filtro-dia-item active" data-dia="Todos" onclick="filtrarPorDia('Todos')">Todos</div>
                        <div class="filtro-dia-item" data-dia="Lunes" onclick="filtrarPorDia('Lunes')">Lunes</div>
                        <div class="filtro-dia-item" data-dia="Martes" onclick="filtrarPorDia('Martes')">Martes</div>
                        <div class="filtro-dia-item" data-dia="Mi√©rcoles" onclick="filtrarPorDia('Mi√©rcoles')">Mi√©rcoles</div>
                        <div class="filtro-dia-item" data-dia="Jueves" onclick="filtrarPorDia('Jueves')">Jueves</div>
                        <div class="filtro-dia-item" data-dia="Viernes" onclick="filtrarPorDia('Viernes')">Viernes</div>
                        <div class="filtro-dia-item" data-dia="S√°bados" onclick="filtrarPorDia('S√°bados')">S√°bados</div>
                        <div class="filtro-dia-item" data-dia="Domingos" onclick="filtrarPorDia('Domingos')">Domingos</div>
                    </div>
                </div>

                <div id="map"></div>

                <!-- Modal Login Requerido -->
                <div class="modal-overlay-mapa" id="modalLoginRequerido" onclick="cerrarModalLogin(event)">
                    <div class="modal-contenido-mapa" onclick="event.stopPropagation()">
                        <button class="modal-cerrar-mapa" onclick="cerrarModalLogin(event)">&times;</button>
                        <div class="modal-login-icono">üîí</div>
                        <h2>Deb√©s iniciar sesi√≥n</h2>
                        <p>Para ver el detalle de las ferias necesit√°s tener una cuenta</p>
                        <div class="modal-login-botones">
                            <a href="/login" class="btn-modal-login">Iniciar sesi√≥n</a>
                            <a href="/registro" class="btn-modal-registro">Crear cuenta</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-panel" id="infoPanel">
                <div class="info-header">
                    <h2>Informaci√≥n de Cuadras</h2>
                </div>
                <div class="info-contenido abierto" id="infoContenido">
                    <div id="feria-info">
                        <p>Haz click en cualquier feria del mapa para ver su informaci√≥n b√°sica.</p>
                        <p style="margin-top: 15px; color: #666; font-size: 0.9em;">üí° Para ver detalles completos de cada feria, visita sus p√°ginas dedicadas desde el lobby.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        var map;
        var capaDia;
        var capaNoche;
        var modoNocturno = false;
        var todasLasLineas = [];
        var categoriaActual = 'Todas';
        var ferias = {{ ferias | tojson }};
        var categoriasColores = {{ categorias_colores | tojson }};
        var marcadoresOfertas = [];
        var marcadoresRecomendaciones = [];
        var ofertasActivo = false;
        var recomendacionesActivo = false;
        var usuarioLogueado = false;
        var urlFeriaActual = '/';

        // Verificar sesi√≥n de usuario
        async function verificarSesion() {
            try {
                const response = await fetch('/api/sesion');
                const data = await response.json();
                usuarioLogueado = data.logged_in;
            } catch (error) {
                console.log('Error verificando sesi√≥n:', error);
            }
        }

        // Mostrar modal de login requerido
        function mostrarModalLoginRequerido(event, url) {
            event.preventDefault();
            if (!usuarioLogueado) {
                urlFeriaActual = url;
                document.getElementById('modalLoginRequerido').classList.add('visible');
            } else {
                window.location.href = url;
            }
        }

        function cerrarModalLogin(event) {
            event.preventDefault();
            document.getElementById('modalLoginRequerido').classList.remove('visible');
        }

        // Verificar sesi√≥n al cargar
        verificarSesion();
        
        // Funci√≥n para cambiar entre modo d√≠a y noche
        function toggleModoNocturno() {
            var boton = document.getElementById('botonModo');
            
            if (!modoNocturno) {
                // Cambiar a modo noche
                map.removeLayer(capaDia);
                capaNoche.addTo(map);
                boton.innerHTML = '‚òÄÔ∏è Modo D√≠a';
                boton.classList.add('activo');
                modoNocturno = true;
                
                // Actualizar colores de las l√≠neas a celeste claro
                todasLasLineas.forEach(function(linea) {
                    linea.setStyle({ color: linea.colorNoche });
                });
            } else {
                // Cambiar a modo d√≠a
                map.removeLayer(capaNoche);
                capaDia.addTo(map);
                boton.innerHTML = 'üåô Modo Nocturno';
                boton.classList.remove('activo');
                modoNocturno = false;
                
                // Actualizar colores de las l√≠neas a azul oscuro
                todasLasLineas.forEach(function(linea) {
                    linea.setStyle({ color: linea.colorDia });
                });
            }
        }
        
        // Funci√≥n para desplegar/plegar la leyenda
        function toggleLeyenda() {
            var contenido = document.getElementById('leyendaContenido');
            var flecha = document.getElementById('flechaLeyenda');
            var leyendaBox = document.getElementById('leyendaBox');
            
            if (contenido.classList.contains('abierto')) {
                contenido.classList.remove('abierto');
                flecha.innerHTML = '‚ñ≤';
                leyendaBox.classList.remove('expandido');
            } else {
                contenido.classList.add('abierto');
                flecha.innerHTML = '‚ñº';
                leyendaBox.classList.add('expandido');
            }
        }
        
        // Funci√≥n para desplegar/plegar el panel de informaci√≥n
        function toggleInfoPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            if (infoPanel.classList.contains('visible')) {
                // Ocultar panel
                infoPanel.classList.remove('visible');
                mainContent.classList.remove('panel-visible');
                flecha.innerHTML = '‚óÄ';
                
                setTimeout(function() {
                    if (!infoPanel.classList.contains('visible')) {
                        infoPanel.style.display = 'none';
                    }
                }, 500);
            } else {
                // Mostrar panel
                infoPanel.style.display = 'block';
                mainContent.classList.add('panel-visible');
                requestAnimationFrame(function() {
                    infoPanel.classList.add('visible');
                    flecha.innerHTML = '‚ñ∂';
                });
            }
        }
        
        // Funci√≥n para filtrar por categor√≠a
        function filtrarCategoria(categoria) {
            categoriaActual = categoria;
            
            // Actualizar estilos de los items de la leyenda
            document.querySelectorAll('.categoria-filtro').forEach(function(item) {
                if (item.dataset.categoria === categoria) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Mostrar/ocultar l√≠neas seg√∫n la categor√≠a
            todasLasLineas.forEach(function(linea) {
                if (categoria === 'Todas' || linea.categoria === categoria) {
                    linea.setStyle({ opacity: 0.9 });
                    if (!map.hasLayer(linea)) {
                        map.addLayer(linea);
                    }
                    if (linea.hitArea && !map.hasLayer(linea.hitArea)) {
                        map.addLayer(linea.hitArea);
                    }
                } else {
                    map.removeLayer(linea);
                    if (linea.hitArea) {
                        map.removeLayer(linea.hitArea);
                    }
                }
            });
            
            // Solo mostrar panel si NO es "Todas"
            if (categoria !== 'Todas') {
                mostrarInfoCategoria(categoria);
            } else {
                // Usar la misma funci√≥n de ocultar que cuando se hace click en el mapa
                ocultarPanel();
            }
        }
        
        // Funci√≥n para mostrar informaci√≥n de una categor√≠a
        function mostrarInfoCategoria(categoria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var boton = document.getElementById('botonInfoToggle');
            
            // Actualizar contenido primero
            var html = '<h3>Categor√≠a: ' + categoria + '</h3>';
            
            if (categoria === 'Todas') {
                html += '<p>Mostrando todas las categor√≠as de la feria. Haz click en una cuadra del mapa para ver detalles espec√≠ficos.</p>';
                html += '<div class="categoria-resumen">';
                for (var cat in categoriasColores) {
                    var color = categoriasColores[cat];
                    html += '<div class="resumen-item" style="border-left-color: ' + color + '">';
                    html += '<strong style="color: ' + color + '">' + cat + '</strong>';
                    html += '</div>';
                }
                html += '</div>';
            } else {
                var color = categoriasColores[categoria];
                html += '<p style="color: ' + color + '">Filtrando por: <strong>' + categoria + '</strong></p>';
                html += '<p>Las cuadras destacadas en el mapa pertenecen a esta categor√≠a. Haz click en una para ver m√°s detalles.</p>';
                
                // Contar cu√°ntas cuadras tienen esta categor√≠a
                var contador = 0;
                ferias.forEach(function(feria) {
                    feria.cuadras.forEach(function(cuadra) {
                        if (cuadra.categoria_principal === categoria) {
                            contador++;
                        }
                    });
                });
                
                html += '<div class="categoria-stats">';
                html += '<p>üìç <strong>' + contador + '</strong> cuadra(s) encontrada(s)</p>';
                html += '</div>';
            }
            
            infoDiv.innerHTML = html;
            
            // Mostrar el panel autom√°ticamente
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Funci√≥n para ocultar el panel
        function ocultarPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            // Quitar ambas clases para animaci√≥n suave
            infoPanel.classList.remove('visible');
            mainContent.classList.remove('panel-visible');
            
            // Ocultar completamente despu√©s de la animaci√≥n
            setTimeout(function() {
                if (!infoPanel.classList.contains('visible')) {
                    infoPanel.style.display = 'none';
                }
            }, 500);
        }
        
        // Mapeo de nombres de ferias a URLs
        var feriasUrls = {
            'Feria de Trist√°n Narvaja': '/tristan-narvaja',
            'Feria Vecinal Juan Paullier': '/juan-paullier',
            'Feria Tres Cruces': '/tres-cruces',
            'Feria Calle Salto': '/calle-salto',
            'Feria Democracia': '/democracia',
            'Feria Acevedo D√≠az': '/acevedo-diaz',
            'Feria San Salvador': '/san-salvador',
            'Feria Isla de Flores': '/isla-flores',
            'Feria Mart√≠nez Trueba': '/martinez-trueba',
            'Feria Julio Herrera y Obes': '/julio-herrera',
            'Feria Acevedo D√≠az (S√°bados)': '/acevedo-diaz-sabados',
            'Feria Guan√°': '/guana',
            'Feria Gaboto (Viernes)': '/gaboto-viernes'
        };

        // Funci√≥n para mostrar informaci√≥n de la feria
        function mostrarInfoFeria(feria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');

            var html = '<h3>' + feria.nombre + '</h3>';
            html += '<p class="feria-dia">üìÖ ' + feria.dia + '</p>';
            html += '<p>Esta es una de las ferias tradicionales de Montevideo.</p>';

            html += '<div class="estadisticas-feria">';
            html += '<div class="stat-item">';
            html += '<span class="stat-numero">' + feria.cuadras.length + '</span>';
            html += '<span class="stat-label">Cuadras</span>';
            html += '</div>';
            html += '</div>';

            // Bot√≥n ir a feria
            var urlFeria = feriasUrls[feria.nombre] || '/';
            html += '<a href="#" class="boton-ir-feria" onclick="mostrarModalLoginRequerido(event, \'' + urlFeria + '\')">Ir a feria ‚Üí</a>';

            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Funci√≥n para mostrar informaci√≥n de la cuadra
        function mostrarInfoCuadra(cuadra, nombreFeria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var boton = document.getElementById('botonInfoToggle');
            var color = categoriasColores[cuadra.categoria_principal];
            
            var html = '<h3>' + nombreFeria + '</h3>';
            html += '<h4 style="color:' + color + '">üìç ' + cuadra.nombre + '</h4>';
            html += '<p class="categoria-principal">Categor√≠a principal: <strong style="color:' + color + '">' + cuadra.categoria_principal + '</strong></p>';
            
            // Mostrar negocios si existen
            if (cuadra.negocios && cuadra.negocios.length > 0) {
                html += '<div class="negocios-section">';
                html += '<h5>üè™ Negocios destacados:</h5>';
                cuadra.negocios.forEach(function(negocio) {
                    html += '<div class="negocio-item">';
                    html += '<h6>' + negocio.nombre + '</h6>';
                    html += '<p class="negocio-desc">' + negocio.descripcion + '</p>';
                    html += '<p class="negocio-especialidad"><strong>Especialidad:</strong> ' + negocio.especialidad + '</p>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Mostrar productos por categor√≠a
            html += '<div class="productos-section">';
            html += '<h5>üì¶ Productos disponibles:</h5>';
            for (var categoria in cuadra.productos) {
                var colorCategoria = categoriasColores[categoria];
                html += '<div class="categoria-section">';
                html += '<h5 style="color:' + colorCategoria + '">' + categoria + '</h5>';
                html += '<ul>';
                cuadra.productos[categoria].forEach(function(producto) {
                    html += '<li>' + producto + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            // Mostrar el panel autom√°ticamente
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Inicializar el mapa
        var montevideoLimites = [
            [-34.95, -56.30],
            [-34.80, -56.05]
        ];

        map = L.map('map', {
            center: [-34.9015, -56.1785],
            zoom: 15.2,
            maxBounds: montevideoLimites,
            maxBoundsViscosity: 1.0,
            minZoom: 12,
            maxZoom: 18,
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true,
            preferCanvas: true
        });

        capaDia = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });

        capaNoche = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });
        
        capaDia.addTo(map);
        
        // Forzar que el mapa se renderice correctamente
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        // Agregar evento click al mapa para cerrar el panel
        map.on('click', function(e) {
            // Solo cerrar si no se hizo click en una l√≠nea
            var clickEnLinea = false;
            todasLasLineas.forEach(function(linea) {
                if (linea.getBounds && linea.getBounds().contains(e.latlng)) {
                    clickEnLinea = true;
                }
            });
            
            if (!clickEnLinea) {
                ocultarPanel();
            }
        });

        // Agregar l√≠neas de colores para cada cuadra
        ferias.forEach(function(feria) {
            feria.cuadras.forEach(function(cuadra) {
                // En el mapa general, todas las cuadras de una feria tienen el mismo color
                var colorDia = '#1a3a52';      // Azul oscuro para modo d√≠a
                var colorNoche = '#4fc3f7';    // Celeste claro para modo noche
                var color = modoNocturno ? colorNoche : colorDia;

                // L√≠nea invisible m√°s gruesa para √°rea clickeable
                var hitArea = L.polyline(cuadra.coordenadas, {
                    color: 'transparent',
                    weight: 30,
                    opacity: 0
                }).addTo(map);

                // L√≠nea visible
                var polyline = L.polyline(cuadra.coordenadas, {
                    color: color,
                    weight: 4,
                    opacity: 0.9
                }).addTo(map);

                polyline.nombreFeria = feria.nombre;
                polyline.categoria = cuadra.categoria_principal;
                polyline.colorDia = colorDia;
                polyline.colorNoche = colorNoche;
                polyline.hitArea = hitArea;
                todasLasLineas.push(polyline);

                // Ambas l√≠neas abren la info
                function abrirInfo() {
                    mostrarInfoFeria(feria);
                }

                polyline.on('click', abrirInfo);
                hitArea.on('click', abrirInfo);

                polyline.bindPopup('<b>' + feria.nombre + '</b>');
                hitArea.bindPopup('<b>' + feria.nombre + '</b>');
            });
        });
        
        // Ajustar el grosor de las l√≠neas seg√∫n el zoom
        map.on('zoomend', function() {
            var zoom = map.getZoom();
            var weight;

            if (zoom >= 16) {
                weight = 6;
            } else if (zoom >= 15) {
                weight = 5;
            } else if (zoom >= 14) {
                weight = 4;
            } else if (zoom >= 13) {
                weight = 3;
            } else {
                weight = 2;
            }

            todasLasLineas.forEach(function(linea) {
                linea.setStyle({ weight: weight });
            });
        });

        // Funci√≥n para obtener el d√≠a actual en formato de las ferias
        function obtenerDiaHoy() {
            var dias = ['Domingos', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bados'];
            var hoy = new Date().getDay();
            return dias[hoy];
        }

        // Funci√≥n para generar n√∫mero aleatorio entre 3 y 11
        function numeroAleatorio() {
            return Math.floor(Math.random() * 9) + 3;
        }

        // Funci√≥n para crear icono personalizado
        function crearIcono(numero, tipo) {
            var color = tipo === 'ofertas' ? '#e74c3c' : '#f39c12';
            var icono = tipo === 'ofertas' ? 'üè∑Ô∏è' : '‚≠ê';
            return L.divIcon({
                className: 'marcador-info-feria',
                html: '<div class="marcador-contenido" style="background-color: ' + color + ';">' +
                      '<span class="marcador-icono">' + icono + '</span>' +
                      '<span class="marcador-numero">' + numero + '</span>' +
                      '</div>',
                iconSize: [60, 30],
                iconAnchor: [30, 30]
            });
        }

        // Funci√≥n para mostrar/ocultar ofertas
        function toggleOfertas() {
            var boton = document.getElementById('botonOfertas');
            var diaHoy = obtenerDiaHoy();

            if (ofertasActivo) {
                // Ocultar ofertas
                marcadoresOfertas.forEach(function(marcador) {
                    map.removeLayer(marcador);
                });
                marcadoresOfertas = [];
                boton.classList.remove('activo');
                ofertasActivo = false;
            } else {
                // Si recomendaciones est√° activo, desactivarlo
                if (recomendacionesActivo) {
                    toggleRecomendaciones();
                }

                // Mostrar ofertas solo de ferias de hoy
                ferias.forEach(function(feria) {
                    if (feria.dia === diaHoy) {
                        var numero = numeroAleatorio();
                        var marcador = L.marker([feria.lat, feria.lng], {
                            icon: crearIcono(numero, 'ofertas')
                        }).addTo(map);

                        marcador.bindPopup('<b>' + feria.nombre + '</b><br>üè∑Ô∏è ' + numero + ' ofertas disponibles hoy');
                        marcadoresOfertas.push(marcador);
                    }
                });

                boton.classList.add('activo');
                ofertasActivo = true;
            }
        }

        // Funci√≥n para mostrar/ocultar recomendaciones
        function toggleRecomendaciones() {
            var boton = document.getElementById('botonRecomendaciones');
            var diaHoy = obtenerDiaHoy();

            if (recomendacionesActivo) {
                // Ocultar recomendaciones
                marcadoresRecomendaciones.forEach(function(marcador) {
                    map.removeLayer(marcador);
                });
                marcadoresRecomendaciones = [];
                boton.classList.remove('activo');
                recomendacionesActivo = false;
            } else {
                // Si ofertas est√° activo, desactivarlo
                if (ofertasActivo) {
                    toggleOfertas();
                }

                // Mostrar recomendaciones solo de ferias de hoy
                ferias.forEach(function(feria) {
                    if (feria.dia === diaHoy) {
                        var numero = numeroAleatorio();
                        var marcador = L.marker([feria.lat, feria.lng], {
                            icon: crearIcono(numero, 'recomendaciones')
                        }).addTo(map);

                        marcador.bindPopup('<b>' + feria.nombre + '</b><br>‚≠ê ' + numero + ' recomendaciones hoy');
                        marcadoresRecomendaciones.push(marcador);
                    }
                });

                boton.classList.add('activo');
                recomendacionesActivo = true;
            }
        }

        // Variables para filtro por d√≠as
        var diaActual = 'Todos';
        var filtroDiasAbierto = false;

        // Funci√≥n para mostrar/ocultar panel de filtro por d√≠as
        function toggleFiltroDias() {
            var panel = document.getElementById('filtroDiasPanel');
            var boton = document.getElementById('botonFiltroDias');

            if (filtroDiasAbierto) {
                panel.classList.remove('visible');
                boton.classList.remove('activo');
                filtroDiasAbierto = false;
            } else {
                panel.classList.add('visible');
                boton.classList.add('activo');
                filtroDiasAbierto = true;
            }
        }

        // Funci√≥n para filtrar ferias por d√≠a
        function filtrarPorDia(dia) {
            diaActual = dia;

            // Actualizar estilos de los items
            document.querySelectorAll('.filtro-dia-item').forEach(function(item) {
                if (item.dataset.dia === dia) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Actualizar texto del bot√≥n
            var boton = document.getElementById('botonFiltroDias');
            if (dia === 'Todos') {
                boton.innerHTML = 'üìÖ Filtrar';
            } else {
                boton.innerHTML = 'üìÖ ' + dia;
            }

            // Filtrar l√≠neas del mapa
            todasLasLineas.forEach(function(linea) {
                var feriaLinea = ferias.find(function(f) {
                    return f.nombre === linea.nombreFeria;
                });

                if (feriaLinea) {
                    if (dia === 'Todos' || feriaLinea.dia === dia) {
                        linea.setStyle({ opacity: 0.9 });
                        if (!map.hasLayer(linea)) {
                            map.addLayer(linea);
                        }
                        if (linea.hitArea && !map.hasLayer(linea.hitArea)) {
                            map.addLayer(linea.hitArea);
                        }
                    } else {
                        map.removeLayer(linea);
                        if (linea.hitArea) {
                            map.removeLayer(linea.hitArea);
                        }
                    }
                }
            });

            // Cerrar panel despu√©s de seleccionar
            toggleFiltroDias();
        }

        // Cerrar filtro al hacer click fuera
        document.addEventListener('click', function(event) {
            var container = document.getElementById('filtroDiasContainer');
            if (container && !container.contains(event.target) && filtroDiasAbierto) {
                toggleFiltroDias();
            }
        });

        // Geolocalizaci√≥n
        var marcadorUsuario = null;
        var circuloPrecision = null;
        var ubicacionActiva = false;
        var watchId = null;
        var longPressTimer = null;
        var isLongPress = false;

        // Configurar eventos del bot√≥n de ubicaci√≥n
        (function() {
            var boton = document.getElementById('botonUbicacion');

            boton.addEventListener('mousedown', function() {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    if (ubicacionActiva) {
                        desactivarUbicacion();
                        boton.innerHTML = 'üìç Mi Ubicaci√≥n';
                        boton.classList.remove('activo');
                    }
                }, 600);
            });

            boton.addEventListener('mouseup', function() {
                clearTimeout(longPressTimer);
                if (!isLongPress) {
                    toggleUbicacion();
                }
            });

            boton.addEventListener('mouseleave', function() {
                clearTimeout(longPressTimer);
            });

            // Soporte t√°ctil
            boton.addEventListener('touchstart', function(e) {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    if (ubicacionActiva) {
                        desactivarUbicacion();
                        boton.innerHTML = 'üìç Mi Ubicaci√≥n';
                        boton.classList.remove('activo');
                    }
                }, 600);
            });

            boton.addEventListener('touchend', function(e) {
                clearTimeout(longPressTimer);
                if (!isLongPress) {
                    e.preventDefault();
                    toggleUbicacion();
                }
            });
        })();

        function toggleUbicacion() {
            var boton = document.getElementById('botonUbicacion');

            if (ubicacionActiva) {
                // Si ya est√° activa, recentrar el mapa en la ubicaci√≥n actual
                if (marcadorUsuario) {
                    var latlng = marcadorUsuario.getLatLng();
                    map.setView([latlng.lat, latlng.lng], 16);
                }
            } else {
                activarUbicacion();
            }
        }

        function activarUbicacion() {
            var boton = document.getElementById('botonUbicacion');

            if (!navigator.geolocation) {
                mostrarPopupUbicacion('Tu navegador no soporta geolocalizaci√≥n');
                return;
            }

            boton.innerHTML = 'üìç Buscando...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    ubicacionActiva = true;
                    boton.innerHTML = 'üìç Ubicaci√≥n ON';
                    boton.classList.add('activo');
                    mostrarUbicacion(position);

                    watchId = navigator.geolocation.watchPosition(
                        mostrarUbicacion,
                        function(error) {
                            console.log('Error en seguimiento:', error.message);
                        },
                        { enableHighAccuracy: true, maximumAge: 5000 }
                    );
                },
                function(error) {
                    boton.innerHTML = 'üìç Mi Ubicaci√≥n';
                    var mensaje = 'No se pudo obtener tu ubicaci√≥n';
                    if (error.code === 1) {
                        mensaje = 'Permiso de ubicaci√≥n denegado';
                    } else if (error.code === 2) {
                        mensaje = 'Ubicaci√≥n no disponible';
                    } else if (error.code === 3) {
                        mensaje = 'Tiempo de espera agotado';
                    }
                    mostrarPopupUbicacion(mensaje);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function mostrarUbicacion(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var precision = position.coords.accuracy;

            var iconoUsuario = L.divIcon({
                className: 'marcador-usuario',
                html: '<div class="pulso"></div><div class="punto-usuario"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            if (marcadorUsuario) {
                marcadorUsuario.setLatLng([lat, lng]);
                circuloPrecision.setLatLng([lat, lng]);
                circuloPrecision.setRadius(precision);
            } else {
                marcadorUsuario = L.marker([lat, lng], { icon: iconoUsuario }).addTo(map);
                marcadorUsuario.bindPopup('üìç Est√°s aqu√≠');

                circuloPrecision = L.circle([lat, lng], {
                    radius: precision,
                    color: '#4285f4',
                    fillColor: '#4285f4',
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

                // Centrar el mapa en la ubicaci√≥n del usuario
                map.setView([lat, lng], 16);
            }
        }

        function desactivarUbicacion() {
            ubicacionActiva = false;

            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            if (marcadorUsuario) {
                map.removeLayer(marcadorUsuario);
                marcadorUsuario = null;
            }

            if (circuloPrecision) {
                map.removeLayer(circuloPrecision);
                circuloPrecision = null;
            }
        }

        function mostrarPopupUbicacion(mensaje) {
            L.popup()
                .setLatLng(map.getCenter())
                .setContent('<div style="text-align: center; padding: 10px;"><b>üìç ' + mensaje + '</b></div>')
                .openOn(map);
        }
    </script>
</body>
</html>