<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Ferias - Montevideo</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="map-container">
                <a href="/" class="boton-volver">
                    ‚Üê Volver
                </a>
                
                <div class="leyenda-flotante" id="leyendaBox" style="display: none;">
                    <div class="leyenda-header" onclick="toggleLeyenda()">
                        <h3>Categor√≠as</h3>
                        <span class="flecha-toggle" id="flechaLeyenda">‚ñ≤</span>
                    </div>
                    <div class="leyenda-contenido" id="leyendaContenido">
                        <div class="leyenda-item-flotante categoria-filtro active" data-categoria="Todas" onclick="filtrarCategoria('Todas')">
                            <span class="color-box-flotante" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                            <span>Todas</span>
                        </div>
                        {% for categoria, color in categorias_colores.items() %}
                        <div class="leyenda-item-flotante categoria-filtro" data-categoria="{{ categoria }}" onclick="filtrarCategoria('{{ categoria }}')">
                            <span class="color-box-flotante" style="background-color: {{ color }};"></span>
                            <span>{{ categoria }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="barra-info-toggle" onclick="toggleInfoPanel()" id="barraInfoToggle">
                    <div class="flecha-barra">‚óÄ</div>
                    <div class="texto-vertical">Informaci√≥n de Cuadras</div>
                </div>
                
                <button class="boton-nocturno" onclick="toggleModoNocturno()" id="botonModo">
                    üåô Modo Nocturno
                </button>
                
                <div id="map"></div>
            </div>
            
            <div class="info-panel" id="infoPanel">
                <div class="info-header">
                    <h2>Informaci√≥n de Cuadras</h2>
                </div>
                <div class="info-contenido abierto" id="infoContenido">
                    <div id="feria-info">
                        <p>Haz click en cualquier feria del mapa para ver su informaci√≥n b√°sica.</p>
                        <p style="margin-top: 15px; color: #666; font-size: 0.9em;">üí° Para ver detalles completos de cada feria, visita sus p√°ginas dedicadas desde el lobby.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        var map;
        var capaDia;
        var capaNoche;
        var modoNocturno = false;
        var todasLasLineas = [];
        var categoriaActual = 'Todas';
        var ferias = {{ ferias | tojson }};
        var categoriasColores = {{ categorias_colores | tojson }};
        
        // Funci√≥n para cambiar entre modo d√≠a y noche
        function toggleModoNocturno() {
            var boton = document.getElementById('botonModo');
            
            if (!modoNocturno) {
                // Cambiar a modo noche
                map.removeLayer(capaDia);
                capaNoche.addTo(map);
                boton.innerHTML = '‚òÄÔ∏è Modo D√≠a';
                boton.classList.add('activo');
                modoNocturno = true;
                
                // Actualizar colores de las l√≠neas a celeste claro
                todasLasLineas.forEach(function(linea) {
                    linea.setStyle({ color: linea.colorNoche });
                });
            } else {
                // Cambiar a modo d√≠a
                map.removeLayer(capaNoche);
                capaDia.addTo(map);
                boton.innerHTML = 'üåô Modo Nocturno';
                boton.classList.remove('activo');
                modoNocturno = false;
                
                // Actualizar colores de las l√≠neas a azul oscuro
                todasLasLineas.forEach(function(linea) {
                    linea.setStyle({ color: linea.colorDia });
                });
            }
        }
        
        // Funci√≥n para desplegar/plegar la leyenda
        function toggleLeyenda() {
            var contenido = document.getElementById('leyendaContenido');
            var flecha = document.getElementById('flechaLeyenda');
            var leyendaBox = document.getElementById('leyendaBox');
            
            if (contenido.classList.contains('abierto')) {
                contenido.classList.remove('abierto');
                flecha.innerHTML = '‚ñ≤';
                leyendaBox.classList.remove('expandido');
            } else {
                contenido.classList.add('abierto');
                flecha.innerHTML = '‚ñº';
                leyendaBox.classList.add('expandido');
            }
        }
        
        // Funci√≥n para desplegar/plegar el panel de informaci√≥n
        function toggleInfoPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            if (infoPanel.classList.contains('visible')) {
                // Ocultar panel
                infoPanel.classList.remove('visible');
                mainContent.classList.remove('panel-visible');
                flecha.innerHTML = '‚óÄ';
                
                setTimeout(function() {
                    if (!infoPanel.classList.contains('visible')) {
                        infoPanel.style.display = 'none';
                    }
                }, 500);
            } else {
                // Mostrar panel
                infoPanel.style.display = 'block';
                mainContent.classList.add('panel-visible');
                requestAnimationFrame(function() {
                    infoPanel.classList.add('visible');
                    flecha.innerHTML = '‚ñ∂';
                });
            }
        }
        
        // Funci√≥n para filtrar por categor√≠a
        function filtrarCategoria(categoria) {
            categoriaActual = categoria;
            
            // Actualizar estilos de los items de la leyenda
            document.querySelectorAll('.categoria-filtro').forEach(function(item) {
                if (item.dataset.categoria === categoria) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Mostrar/ocultar l√≠neas seg√∫n la categor√≠a
            todasLasLineas.forEach(function(linea) {
                if (categoria === 'Todas' || linea.categoria === categoria) {
                    linea.setStyle({ opacity: 0.9 });
                    map.addLayer(linea);
                } else {
                    map.removeLayer(linea);
                }
            });
            
            // Solo mostrar panel si NO es "Todas"
            if (categoria !== 'Todas') {
                mostrarInfoCategoria(categoria);
            } else {
                // Usar la misma funci√≥n de ocultar que cuando se hace click en el mapa
                ocultarPanel();
            }
        }
        
        // Funci√≥n para mostrar informaci√≥n de una categor√≠a
        function mostrarInfoCategoria(categoria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var boton = document.getElementById('botonInfoToggle');
            
            // Actualizar contenido primero
            var html = '<h3>Categor√≠a: ' + categoria + '</h3>';
            
            if (categoria === 'Todas') {
                html += '<p>Mostrando todas las categor√≠as de la feria. Haz click en una cuadra del mapa para ver detalles espec√≠ficos.</p>';
                html += '<div class="categoria-resumen">';
                for (var cat in categoriasColores) {
                    var color = categoriasColores[cat];
                    html += '<div class="resumen-item" style="border-left-color: ' + color + '">';
                    html += '<strong style="color: ' + color + '">' + cat + '</strong>';
                    html += '</div>';
                }
                html += '</div>';
            } else {
                var color = categoriasColores[categoria];
                html += '<p style="color: ' + color + '">Filtrando por: <strong>' + categoria + '</strong></p>';
                html += '<p>Las cuadras destacadas en el mapa pertenecen a esta categor√≠a. Haz click en una para ver m√°s detalles.</p>';
                
                // Contar cu√°ntas cuadras tienen esta categor√≠a
                var contador = 0;
                ferias.forEach(function(feria) {
                    feria.cuadras.forEach(function(cuadra) {
                        if (cuadra.categoria_principal === categoria) {
                            contador++;
                        }
                    });
                });
                
                html += '<div class="categoria-stats">';
                html += '<p>üìç <strong>' + contador + '</strong> cuadra(s) encontrada(s)</p>';
                html += '</div>';
            }
            
            infoDiv.innerHTML = html;
            
            // Mostrar el panel autom√°ticamente
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Funci√≥n para ocultar el panel
        function ocultarPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            // Quitar ambas clases para animaci√≥n suave
            infoPanel.classList.remove('visible');
            mainContent.classList.remove('panel-visible');
            
            // Ocultar completamente despu√©s de la animaci√≥n
            setTimeout(function() {
                if (!infoPanel.classList.contains('visible')) {
                    infoPanel.style.display = 'none';
                }
            }, 500);
        }
        
        // Funci√≥n para mostrar informaci√≥n de la feria
        function mostrarInfoFeria(feria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            var html = '<h3>' + feria.nombre + '</h3>';
            html += '<p>Esta es una de las ferias tradicionales de Montevideo.</p>';
            
            html += '<div class="estadisticas-feria">';
            html += '<div class="stat-item">';
            html += '<span class="stat-numero">' + feria.cuadras.length + '</span>';
            html += '<span class="stat-label">Cuadras</span>';
            html += '</div>';
            html += '</div>';
            
            html += '<p style="margin-top: 20px;">Para ver m√°s detalles de esta feria, visita su p√°gina dedicada desde el lobby.</p>';
            
            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Funci√≥n para mostrar informaci√≥n de la cuadra
        function mostrarInfoCuadra(cuadra, nombreFeria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var boton = document.getElementById('botonInfoToggle');
            var color = categoriasColores[cuadra.categoria_principal];
            
            var html = '<h3>' + nombreFeria + '</h3>';
            html += '<h4 style="color:' + color + '">üìç ' + cuadra.nombre + '</h4>';
            html += '<p class="categoria-principal">Categor√≠a principal: <strong style="color:' + color + '">' + cuadra.categoria_principal + '</strong></p>';
            
            // Mostrar negocios si existen
            if (cuadra.negocios && cuadra.negocios.length > 0) {
                html += '<div class="negocios-section">';
                html += '<h5>üè™ Negocios destacados:</h5>';
                cuadra.negocios.forEach(function(negocio) {
                    html += '<div class="negocio-item">';
                    html += '<h6>' + negocio.nombre + '</h6>';
                    html += '<p class="negocio-desc">' + negocio.descripcion + '</p>';
                    html += '<p class="negocio-especialidad"><strong>Especialidad:</strong> ' + negocio.especialidad + '</p>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Mostrar productos por categor√≠a
            html += '<div class="productos-section">';
            html += '<h5>üì¶ Productos disponibles:</h5>';
            for (var categoria in cuadra.productos) {
                var colorCategoria = categoriasColores[categoria];
                html += '<div class="categoria-section">';
                html += '<h5 style="color:' + colorCategoria + '">' + categoria + '</h5>';
                html += '<ul>';
                cuadra.productos[categoria].forEach(function(producto) {
                    html += '<li>' + producto + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            // Mostrar el panel autom√°ticamente
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Inicializar el mapa
        var montevideoLimites = [
            [-34.95, -56.30],
            [-34.80, -56.05]
        ];

        map = L.map('map', {
            center: [-34.9015, -56.1785],
            zoom: 15.2,
            maxBounds: montevideoLimites,
            maxBoundsViscosity: 1.0,
            minZoom: 12,
            maxZoom: 18,
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true,
            preferCanvas: true
        });

        capaDia = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });

        capaNoche = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });
        
        capaDia.addTo(map);
        
        // Forzar que el mapa se renderice correctamente
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        // Agregar evento click al mapa para cerrar el panel
        map.on('click', function(e) {
            // Solo cerrar si no se hizo click en una l√≠nea
            var clickEnLinea = false;
            todasLasLineas.forEach(function(linea) {
                if (linea.getBounds && linea.getBounds().contains(e.latlng)) {
                    clickEnLinea = true;
                }
            });
            
            if (!clickEnLinea) {
                ocultarPanel();
            }
        });

        // Agregar l√≠neas de colores para cada cuadra
        ferias.forEach(function(feria) {
            feria.cuadras.forEach(function(cuadra) {
                // En el mapa general, todas las cuadras de una feria tienen el mismo color
                var colorDia = '#1a3a52';      // Azul oscuro para modo d√≠a
                var colorNoche = '#4fc3f7';    // Celeste claro para modo noche
                var color = modoNocturno ? colorNoche : colorDia;
                
                var polyline = L.polyline(cuadra.coordenadas, {
                    color: color,
                    weight: 4,
                    opacity: 0.9
                }).addTo(map);

                polyline.nombreFeria = feria.nombre;
                polyline.categoria = cuadra.categoria_principal;
                polyline.colorDia = colorDia;
                polyline.colorNoche = colorNoche;
                todasLasLineas.push(polyline);

                polyline.on('click', function() {
                    mostrarInfoFeria(feria);
                });

                polyline.bindPopup('<b>' + feria.nombre + '</b>');
            });
        });
        
        // Ajustar el grosor de las l√≠neas seg√∫n el zoom
        map.on('zoomend', function() {
            var zoom = map.getZoom();
            var weight;
            
            if (zoom >= 16) {
                weight = 6;
            } else if (zoom >= 15) {
                weight = 5;
            } else if (zoom >= 14) {
                weight = 4;
            } else if (zoom >= 13) {
                weight = 3;
            } else {
                weight = 2;
            }
            
            todasLasLineas.forEach(function(linea) {
                linea.setStyle({ weight: weight });
            });
        });
    </script>
</body>
</html>