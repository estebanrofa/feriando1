<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feria Juan Paullier - Feriando.uy</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="map-container">
                <a href="/" class="boton-volver" onclick="sessionStorage.setItem('navegacionInterna', 'true')">
                    ‚Üê Volver al Lobby
                </a>
                
                <div class="header-feria">
                    <h1>ü•¨ Feria Juan Paullier</h1>
                    <p>Tres Cruces - Productos frescos de barrio</p>
                </div>
                
                <div class="leyenda-flotante" id="leyendaBox">
                    <div class="leyenda-header" onclick="toggleLeyenda()">
                        <h3>Categor√≠as</h3>
                        <span class="flecha-toggle" id="flechaLeyenda">‚ñ≤</span>
                    </div>
                    <div class="leyenda-contenido" id="leyendaContenido">
                        <div class="leyenda-item-flotante categoria-filtro active" data-categoria="Todas" onclick="filtrarCategoria('Todas')">
                            <span class="color-box-flotante" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                            <span>Todas</span>
                        </div>
                        {% for categoria, color in categorias_colores.items() %}
                        <div class="leyenda-item-flotante categoria-filtro" data-categoria="{{ categoria }}" onclick="filtrarCategoria('{{ categoria }}')">
                            <span class="color-box-flotante" style="background-color: {{ color }};"></span>
                            <span>{{ categoria }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="barra-info-toggle" onclick="toggleInfoPanel()" id="barraInfoToggle">
                    <div class="flecha-barra">‚óÄ</div>
                    <div class="texto-vertical">Informaci√≥n de Cuadras</div>
                </div>
                
                <button class="boton-nocturno" onclick="toggleModoNocturno()" id="botonModo">
                    üåô Modo Nocturno
                </button>

                <div class="botones-info-ferias">
                    <button class="boton-info-feria" onclick="toggleOfertas()" id="botonOfertas">
                        üè∑Ô∏è Ofertas
                    </button>
                    <button class="boton-info-feria" onclick="toggleRecomendaciones()" id="botonRecomendaciones">
                        ‚≠ê Recomendaciones
                    </button>
                </div>

                <div id="map"></div>
            </div>
            
            <div class="info-panel" id="infoPanel">
                <div class="info-header">
                    <h2>Informaci√≥n de Cuadras</h2>
                </div>
                <div class="info-contenido abierto" id="infoContenido">
                    <div id="feria-info">
                        <h3>{{ feria.nombre }}</h3>
                        <p>Haz click en cualquier cuadra del mapa para ver sus productos y negocios.</p>
                        
                        <div class="estadisticas-feria">
                            <div class="stat-item">
                                <span class="stat-numero">{{ feria.cuadras|length }}</span>
                                <span class="stat-label">Cuadras</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-numero">{{ categorias_colores|length }}</span>
                                <span class="stat-label">Categor√≠as</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        var map;
        var capaDia;
        var capaNoche;
        var modoNocturno = false;
        var todasLasLineas = [];
        var categoriaActual = 'Todas';
        var feria = {{ feria | tojson }};
        var categoriasColores = {{ categorias_colores | tojson }};
        var limitesFeria = {{ limites_feria | tojson }};
        var marcadoresRecomendaciones = [];
        var marcadoresOfertas = [];
        var recomendacionesActivo = false;
        var ofertasActivo = false;
        
        // Funci√≥n para cambiar entre modo d√≠a y noche
        function toggleModoNocturno() {
            var boton = document.getElementById('botonModo');
            
            if (!modoNocturno) {
                map.removeLayer(capaDia);
                capaNoche.addTo(map);
                boton.innerHTML = '‚òÄÔ∏è Modo D√≠a';
                boton.classList.add('activo');
                modoNocturno = true;
            } else {
                map.removeLayer(capaNoche);
                capaDia.addTo(map);
                boton.innerHTML = 'üåô Modo Nocturno';
                boton.classList.remove('activo');
                modoNocturno = false;
            }
        }
        
        // Funci√≥n para desplegar/plegar la leyenda
        function toggleLeyenda() {
            var contenido = document.getElementById('leyendaContenido');
            var flecha = document.getElementById('flechaLeyenda');
            var leyendaBox = document.getElementById('leyendaBox');
            
            if (contenido.classList.contains('abierto')) {
                contenido.classList.remove('abierto');
                flecha.innerHTML = '‚ñ≤';
                leyendaBox.classList.remove('expandido');
            } else {
                contenido.classList.add('abierto');
                flecha.innerHTML = '‚ñº';
                leyendaBox.classList.add('expandido');
            }
        }
        
        // Funci√≥n para desplegar/plegar el panel de informaci√≥n
        function toggleInfoPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            if (infoPanel.classList.contains('visible')) {
                infoPanel.classList.remove('visible');
                mainContent.classList.remove('panel-visible');
                flecha.innerHTML = '‚óÄ';
                
                setTimeout(function() {
                    if (!infoPanel.classList.contains('visible')) {
                        infoPanel.style.display = 'none';
                    }
                }, 500);
            } else {
                infoPanel.style.display = 'block';
                mainContent.classList.add('panel-visible');
                requestAnimationFrame(function() {
                    infoPanel.classList.add('visible');
                    flecha.innerHTML = '‚ñ∂';
                });
            }
        }
        
        // Funci√≥n para filtrar por categor√≠a
        function filtrarCategoria(categoria) {
            categoriaActual = categoria;
            
            document.querySelectorAll('.categoria-filtro').forEach(function(item) {
                if (item.dataset.categoria === categoria) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            todasLasLineas.forEach(function(linea) {
                if (categoria === 'Todas' || linea.categoria === categoria) {
                    linea.setStyle({ opacity: 0.9 });
                    map.addLayer(linea);
                } else {
                    map.removeLayer(linea);
                }
            });
            
            if (categoria !== 'Todas') {
                mostrarInfoCategoria(categoria);
            } else {
                ocultarPanel();
            }
        }
        
        // Funci√≥n para mostrar informaci√≥n de una categor√≠a
        function mostrarInfoCategoria(categoria) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            var html = '<h3>Categor√≠a: ' + categoria + '</h3>';
            var color = categoriasColores[categoria];
            html += '<p style="color: ' + color + '">Filtrando por: <strong>' + categoria + '</strong></p>';
            html += '<p>Las cuadras destacadas en el mapa pertenecen a esta categor√≠a. Haz click en una para ver m√°s detalles.</p>';
            
            var contador = 0;
            feria.cuadras.forEach(function(cuadra) {
                if (cuadra.categoria_principal === categoria) {
                    contador++;
                }
            });
            
            html += '<div class="categoria-stats">';
            html += '<p>üìç <strong>' + contador + '</strong> cuadra(s) encontrada(s)</p>';
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Funci√≥n para ocultar el panel
        function ocultarPanel() {
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            
            infoPanel.classList.remove('visible');
            mainContent.classList.remove('panel-visible');
            
            setTimeout(function() {
                if (!infoPanel.classList.contains('visible')) {
                    infoPanel.style.display = 'none';
                }
            }, 500);
        }
        
        // Funci√≥n para mostrar informaci√≥n de la cuadra
        function mostrarInfoCuadra(cuadra) {
            var infoDiv = document.getElementById('feria-info');
            var infoPanel = document.querySelector('.info-panel');
            var mainContent = document.querySelector('.main-content');
            var color = categoriasColores[cuadra.categoria_principal];
            
            var html = '<h3>' + feria.nombre + '</h3>';
            html += '<h4 style="color:' + color + '">üìç ' + cuadra.nombre + '</h4>';
            html += '<p class="categoria-principal">Categor√≠a principal: <strong style="color:' + color + '">' + cuadra.categoria_principal + '</strong></p>';
            
            if (cuadra.negocios && cuadra.negocios.length > 0) {
                html += '<div class="negocios-section">';
                html += '<h5>üè™ Negocios destacados:</h5>';
                cuadra.negocios.forEach(function(negocio) {
                    html += '<div class="negocio-item">';
                    html += '<h6>' + negocio.nombre + '</h6>';
                    html += '<p class="negocio-desc">' + negocio.descripcion + '</p>';
                    html += '<p class="negocio-especialidad"><strong>Especialidad:</strong> ' + negocio.especialidad + '</p>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '<div class="productos-section">';
            html += '<h5>üì¶ Productos disponibles:</h5>';
            for (var categoria in cuadra.productos) {
                var colorCategoria = categoriasColores[categoria];
                html += '<div class="categoria-section">';
                html += '<h5 style="color:' + colorCategoria + '">' + categoria + '</h5>';
                html += '<ul>';
                cuadra.productos[categoria].forEach(function(producto) {
                    html += '<li>' + producto + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }
            html += '</div>';
            
            infoDiv.innerHTML = html;
            
            var barra = document.getElementById('barraInfoToggle');
            var flecha = barra.querySelector('.flecha-barra');
            
            infoPanel.style.display = 'block';
            mainContent.classList.add('panel-visible');
            requestAnimationFrame(function() {
                infoPanel.classList.add('visible');
                flecha.innerHTML = '‚ñ∂';
            });
        }
        
        // Calcular el centro y bounds de la feria
        var polygon = L.polygon(limitesFeria);
        var bounds = polygon.getBounds();
        var zoomInicial = 16.2;

        // Expandir los l√≠mites un poco para dar margen al mover
        var maxBounds = bounds.pad(0.5);

        // Inicializar el mapa con zoom controlado (mismo que Trist√°n Narvaja)
        map = L.map('map', {
            center: bounds.getCenter(),
            zoom: zoomInicial,
            minZoom: zoomInicial,
            maxZoom: 18,
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            touchZoom: true,
            dragging: false,
            maxBounds: maxBounds,
            maxBoundsViscosity: 1.0
        });

        // Habilitar/deshabilitar dragging seg√∫n el nivel de zoom
        map.on('zoomend', function() {
            if (map.getZoom() > zoomInicial) {
                map.dragging.enable();
            } else {
                map.dragging.disable();
                // Volver al centro cuando est√° en zoom inicial
                map.setView(bounds.getCenter(), zoomInicial);
            }
        });

        capaDia = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });

        capaNoche = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 18,
            updateWhenIdle: false,
            updateWhenZooming: false,
            keepBuffer: 6,
            crossOrigin: 'anonymous'
        });
        
        capaDia.addTo(map);
        
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        map.on('click', function(e) {
            var clickEnLinea = false;
            todasLasLineas.forEach(function(linea) {
                if (linea.getBounds && linea.getBounds().contains(e.latlng)) {
                    clickEnLinea = true;
                }
            });
            
            if (!clickEnLinea) {
                ocultarPanel();
            }
        });

        // Agregar l√≠neas de colores para cada cuadra
        feria.cuadras.forEach(function(cuadra) {
            var color = categoriasColores[cuadra.categoria_principal];
            
            var polyline = L.polyline(cuadra.coordenadas, {
                color: color,
                weight: 6,
                opacity: 0.9
            }).addTo(map);

            polyline.categoria = cuadra.categoria_principal;
            todasLasLineas.push(polyline);

            polyline.on('click', function() {
                mostrarInfoCuadra(cuadra);
            });

            polyline.bindPopup(
                '<b>' + cuadra.nombre + '</b><br>' +
                'Categor√≠a principal: <span style="color:' + color + '"><b>' + cuadra.categoria_principal + '</b></span>'
            );
        });

        // Funci√≥n para crear icono de emoji con cartel (lado: 'izq' o 'der')
        function crearIconoEmoji(emoji, lado) {
            var flechaClass = lado === 'izq' ? 'flecha-derecha' : 'flecha-izquierda';
            // iconAnchor en la punta de la flecha para que apenas toque la feria
            return L.divIcon({
                className: 'marcador-cartel-emoji',
                html: '<div class="cartel-emoji ' + lado + '">' +
                      '<div class="cartel-contenido">' + emoji + '</div>' +
                      '<div class="cartel-flecha ' + flechaClass + '"></div>' +
                      '</div>',
                iconSize: [60, 45],
                iconAnchor: lado === 'izq' ? [60, 22] : [0, 22]
            });
        }

        // Funci√≥n para crear icono de oferta con cartel
        function crearIconoOferta(emoji, lado) {
            var flechaClass = lado === 'izq' ? 'flecha-derecha' : 'flecha-izquierda';
            return L.divIcon({
                className: 'marcador-cartel-emoji',
                html: '<div class="cartel-emoji oferta ' + lado + '">' +
                      '<div class="cartel-contenido">' + emoji + '<span class="texto-oferta">Oferta!</span></div>' +
                      '<div class="cartel-flecha ' + flechaClass + '"></div>' +
                      '</div>',
                iconSize: [110, 45],
                iconAnchor: lado === 'izq' ? [110, 22] : [0, 22]
            });
        }

        // Coordenadas del tramo de mercado (primer tramo)
        var coordsMercado = feria.cuadras[0].coordenadas;
        var puntoInicio = coordsMercado[0];
        var puntoFin = coordsMercado[1];

        // Calcular puntos para los emojis (en la l√≠nea de la feria)
        var puntoFrutas = [
            puntoInicio[0] + (puntoFin[0] - puntoInicio[0]) * 0.3,
            puntoInicio[1] + (puntoFin[1] - puntoInicio[1]) * 0.3
        ];
        var puntoPescado = [
            puntoInicio[0] + (puntoFin[0] - puntoInicio[0]) * 0.7,
            puntoInicio[1] + (puntoFin[1] - puntoInicio[1]) * 0.7
        ];
        // Punto para la oferta (centro del tramo)
        var puntoOferta = [
            puntoInicio[0] + (puntoFin[0] - puntoInicio[0]) * 0.5,
            puntoInicio[1] + (puntoFin[1] - puntoInicio[1]) * 0.5
        ];

        // Funci√≥n para mostrar/ocultar recomendaciones
        function toggleRecomendaciones() {
            var boton = document.getElementById('botonRecomendaciones');

            if (recomendacionesActivo) {
                // Ocultar recomendaciones
                marcadoresRecomendaciones.forEach(function(marcador) {
                    map.removeLayer(marcador);
                });
                marcadoresRecomendaciones = [];
                boton.classList.remove('activo');
                recomendacionesActivo = false;
            } else {
                // Si ofertas est√° activo, desactivarlo
                if (ofertasActivo) {
                    toggleOfertas();
                }

                // Mostrar recomendaciones (frutas sale a la izquierda, pescado a la derecha)
                var marcadorFrutas = L.marker(puntoFrutas, {
                    icon: crearIconoEmoji('üçé', 'izq')
                }).addTo(map);
                marcadorFrutas.bindPopup('<b>Recomendaci√≥n</b><br>Frutas frescas de estaci√≥n');
                marcadoresRecomendaciones.push(marcadorFrutas);

                var marcadorPescado = L.marker(puntoPescado, {
                    icon: crearIconoEmoji('üêü', 'der')
                }).addTo(map);
                marcadorPescado.bindPopup('<b>Recomendaci√≥n</b><br>Pescado fresco del d√≠a');
                marcadoresRecomendaciones.push(marcadorPescado);

                boton.classList.add('activo');
                recomendacionesActivo = true;
            }
        }

        // Funci√≥n para mostrar/ocultar ofertas
        function toggleOfertas() {
            var boton = document.getElementById('botonOfertas');

            if (ofertasActivo) {
                // Ocultar ofertas
                marcadoresOfertas.forEach(function(marcador) {
                    map.removeLayer(marcador);
                });
                marcadoresOfertas = [];
                boton.classList.remove('activo');
                ofertasActivo = false;
            } else {
                // Si recomendaciones est√° activo, desactivarlo
                if (recomendacionesActivo) {
                    toggleRecomendaciones();
                }

                // Mostrar oferta (huevo) - sale a la izquierda
                var marcadorHuevo = L.marker(puntoOferta, {
                    icon: crearIconoOferta('ü•ö', 'izq')
                }).addTo(map);
                marcadorHuevo.bindPopup('<b>ü•ö Oferta del d√≠a!</b><br>Huevos de campo a precio especial');
                marcadoresOfertas.push(marcadorHuevo);

                boton.classList.add('activo');
                ofertasActivo = true;
            }
        }
    </script>
</body>
</html>